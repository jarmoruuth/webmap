<!DOCTYPE html>
<html>
  <head>
    <title>map 0.28</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4-src.js"></script>    
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // Note: This example requires that you consent to location sharing when
      // prompted by your browser. If you see the error "The Geolocation service
      // failed.", it means you probably did not give permission for the browser to
      // locate you.
      var map;
      var id, infoWindow, marker, options
      var current_location = {lat: 60.2053791, lng: 24.6540694};          // Espoo
      //var current_location = {lat: 60.124932, lng: 24.439290};    // Kirkkonummi
      var autoMove = true;
      var path = [];                // path of last positions
      var maxpath = 10;             // max path points to save
      var pathinterval = 10000;     // interval for storing path points
      var recording_distance = 10;  // distance between points before we record a new one
      var circle_radius = 5;
      var centerMarker;
      var url_markers = [];
      var start_location = current_location;
      var map_zoom = 15;
      var start_maptypeid;
      var supportHTML5Dialog;
      var layerDialog;
      var layers = [
                      { name : 'Lynx', 
                        shortname : 'Lynx',
                        visible : false, 
                        type : 'kml', 
                        url : 'https://ruuth.xyz/Lynx.kmz', 
                        layer : null 
                      },
                      { name : 'Muinaisjäännökset', 
                        shortname : 'Muinj',
                        visible : false, 
                        type : 'fusion',  
                        col : '\'sijainti\'', 
                        tab : '1BTqOeSzHYH_ub8-ef_BbUvP-s89VjEdfvtyKVMk', 
                        layer : null 
                      },
                      { name : 'Planetskier', 
                        shortname : 'Planetski',
                        visible : false, 
                        type : 'kml', 
                        url : 'https://planetskier.net/locations.kmz', 
                        layer : null 
                      },
                      { name : 'Jarmo', 
                        shortname : 'Jarmo',
                        visible : false, 
                        type : 'kml', 
                        url : 'https://ruuth.xyz/EspoonLahiretkia.kml', 
                        layer : null }
                   ];

      console.log('*** body ***');

      // check parameters from url
      //
      var url = new URL(window.location);
      console.log(url);
      var searchParams = new URLSearchParams(url.search.slice(1));

      // check kml parameters for a new layers
      // kml=<url>,<name>[,<shortname>]
      //
      var kmlparams = searchParams.getAll('kml');
      for (var i = 0; i < kmlparams.length; i++) {
        var kml = kmlparams[i];
        console.log('kml param['+i+']='+kml);
        var newlayer = {};
        var newvalues = kml.split(',');
        console.log('newvalues=', newvalues);
        if (newvalues[0] && newvalues[1]) {
          console.log('add new kml layer, newvalues=', newvalues);
          newlayer.type = 'kml';
          newlayer.url = newvalues[0];
          newlayer.name = newvalues[1];
          if (newvalues[2]) {
            newlayer.shortname = newvalues[2];
          } else {
            newlayer.shortname = newlayer.name.substring(0, 7);
          }
          newlayer.visible = false;
          newlayer.layer = null;
          layers[layers.length] = newlayer;
        } else {
          console.log('new kml layer needs url and name, newvalues=', newvalues);            
        }
      }

      // check fusion table parameters for a new layers
      // fusion=<column>,<table<>,<name>[,<shortname>]
      //
      var fusionparams = searchParams.getAll('fusion');
      for (var i = 0; i < fusionparams.length; i++) {
        var fusion = fusionparams[i];
        console.log('fusion param['+i+']='+fusion);
        var newlayer = {};
        var newvalues = fusion.split(',');
        console.log('newvalues=', newvalues);
        if (newvalues[0] && newvalues[1]) {
          console.log('add new fusion layer, newvalues=', newvalues);
          newlayer.type = 'fusion';
          newlayer.col = newvalues[0];
          newlayer.tab = newvalues[1];
          newlayer.name = newvalues[2];
          if (newvalues[3]) {
            newlayer.shortname = newvalues[3];
          } else {
            newlayer.shortname = newlayer.name.substring(0, 7);
          }
          newlayer.visible = false;
          newlayer.layer = null;
          layers[layers.length] = newlayer;
        } else {
          console.log('new fusion layer needs column, table and name, newvalues=', newvalues);
        }
      }

      // check path parameters
      // path=<max path points>[,<interval in seconds>[,<recording distance in meters>]]
      // path=0 disables path printing
      //
      var pathparams = searchParams.get('path');
      if (pathparams) {
        var newvalues = pathparams.split(',');
        if (newvalues[0]) {
          maxpath = Number(newvalues[0]);
          console.log('new maxpath='+maxpath);
        }
        if (newvalues[1]) {
          pathinterval = Number(newvalues[1]) * 1000;
          console.log('pathinterval='+pathinterval);
        }
        if (newvalues[2]) {
          recording_distance = Number(newvalues[2]);
          console.log('recording_distance='+recording_distance);
        }
      }

      // check map center from url
      var centerparams = searchParams.get('center');
      if (centerparams) {
        console.log('centerparams='+centerparams);
        var newvalues = centerparams.split(',');
        var urlPos = {
              lat: Number(newvalues[0]),
              lng: Number(newvalues[1])
        };
        var urlMarker = {
              pos : urlPos,
              label : newvalues[2] ? newvalues[2] : 'C'
        };
        url_markers[url_markers.length] = urlMarker;
        if (!sessionStorage.getItem('Lat')) {
          // not saved center, get from url
          start_location = urlPos;
          autoMove = false;
        }
      }

      // check markers from url
      var markerparams = searchParams.getAll('marker');
      for (var i = 0; i < markerparams.length; i++)  {
        console.log('markerparams='+markerparams[i]);
        var params = markerparams[i];
        var newvalues = params.split(',');
        var urlPos = {
              lat: Number(newvalues[0]),
              lng: Number(newvalues[1])
        };
        var urlMarker = {
              pos : urlPos,
              label : newvalues[2] ? newvalues[2] : 'M'
        };
        url_markers[url_markers.length] = urlMarker;        
      }      

      // check visible layers
      if (!sessionStorage.getItem('Lat')) {
        // no saved data, get from url
        var layersparams = searchParams.get('layers');
        if (layersparams) {
          console.log('layersparams='+layersparams);
          var newvalues = layersparams.split(',');
          for (var i = 0; i < newvalues.length; i++) {
            for (var j = 0; j < layers.length; j++) {
              if (layers[j].name == newvalues[i])  {
                console.log('set visible, layer='+layers[j].name);
                layers[j].visible = true;
              }
            }
          }
        }
      }

      // check if HTML5 dialog is supported. If not we use full down menu for layers
      //
      if (typeof HTMLDialogElement === 'function') {
        supportHTML5Dialog = true;
      } else {
        supportHTML5Dialog = false;
      }

      restoreState(true);

      // ------------------------------------------------------------
      // save current state to session storage

      function saveBool(name, val) {
        if (val) {
          sessionStorage.setItem(name, String('1'));          
        } else {
          sessionStorage.setItem(name, String('0'));
        }
      }

      function saveState() {
        var visible_layers = '';
        var map_center = map.getCenter();
        console.log("saveState:lat="+map_center.lat()+",lng="+map_center.lng()+',Zoom='+map.getZoom()+'MapTypeId='+map.getMapTypeId()
                     +'AutoMove='+autoMove);
        sessionStorage.setItem('Lat', String(map_center.lat()));
        sessionStorage.setItem('Lng', String(map_center.lng()));
        sessionStorage.setItem('Zoom', String(map.getZoom()));
        sessionStorage.setItem('MapTypeId', map.getMapTypeId());
        console.log("saveState:autoMove="+autoMove);
        saveBool('AutoMove', autoMove);
        for (var i = 0; i < layers.length; i++) {
          if (layers[i].visible) {
            visible_layers = visible_layers + layers[i].name + ' ';
          }
        }
        console.log(visible_layers);
        sessionStorage.setItem('VisibleLayers', visible_layers);
        if (path.length > 0) {
          var save_path = '';
          for (var i = 0; i < path.length; i++) {
            var pos = path[i].getCenter();
            var posJSON = pos.toJSON();
            save_path = save_path + JSON.stringify(posJSON) + ' ';
          }
          //alert(save_path);
          sessionStorage.setItem('Path', save_path);
        }
      }

      // ------------------------------------------------------------
      // restore current state from session storate

      function restoreBool(name) {
        var num = Number(sessionStorage.getItem(name));
          if (num) {
            return true;
          } else {
            return false;
          }
      }

      function restoreState(atStart) {
        if (sessionStorage.getItem('AutoMove')) {
          autoMove = restoreBool('AutoMove');
          if (centerMarker) {
            centerMarker.setVisible(!autoMove);
          }
          console.log("restoreState:autoMove="+autoMove);
        } else {
          console.log("restoreState:could not restore autoMove");
        }
        if (sessionStorage.getItem('Lat') 
            && sessionStorage.getItem('Lng')
            && sessionStorage.getItem('Zoom')
            && sessionStorage.getItem('MapTypeId')) 
        {
          var pos = {
                lat: Number(sessionStorage.getItem('Lat')),
                lng: Number(sessionStorage.getItem('Lng'))
          };
          start_location = pos;
          console.log("restoreState:lat="+pos.lat+",lng="+pos.lng+
                      ',Zoom='+sessionStorage.getItem('Zoom')+
                      ',MapTypeId='+sessionStorage.getItem('MapTypeId'));
          start_maptypeid = sessionStorage.getItem('MapTypeId');       
          map_zoom = Number(sessionStorage.getItem('Zoom'));
          if (map) {
            map.setMapTypeId(start_maptypeid);
            map.setZoom(map_zoom);
            map.panTo(pos);
          }
          updateCircleRadius(map_zoom);
        } else {
          console.log("restoreState:could not restore lat,lng,Zoom,MapTypeId");          
        }
        if (sessionStorage.getItem('VisibleLayers')) {
          var visible_layers = sessionStorage.getItem('VisibleLayers').split(' ');
          console.log(visible_layers);
          for (var i = 0; i < visible_layers.length; i++) {
              for (var j = 0; j < layers.length; j++) {
                if (visible_layers[i] == layers[j].name) {
                  layers[j].visible = true;
                }
              }
          }
        } else {
          console.log('restoreState:could not restore VisibleLayers');
        }
        if (!atStart) {
          if (sessionStorage.getItem('Path')) {
            var saved_path = sessionStorage.getItem('Path').split(' ');
            console.log(saved_path);
            for (var i = 0; i < saved_path.length && saved_path[i].length > 5; i++) {
              console.log('saved_path['+i+']='+saved_path[i]);
              var json = JSON.parse(saved_path[i]);
              path[path.length] = pathCircle({
                                      lat: json['lat'],
                                      lng: json['lng']
                                    });
            }
          } else {
            console.log('restoreState:could not restore Path');
          }
        }
      }        

      // ------------------------------------------------------------
      // load layer

      function loadLayer(layer) {
        if (!layer.layer) {
          if (layer.type == 'kml') {
            console.log("loadLayer:create new kml layer, layer=", layer.name);            
            layer.layer = new google.maps.KmlLayer(layer.url, {
                preserveViewport: true,
                suppressInfoWindows: false
            });
          } else if (layer.type == 'fusion') {
            console.log("loadLayer:create new fusion layer, layer=", layer.name);            
            layer.layer = new google.maps.FusionTablesLayer({
              query: {
                select: layer.col,
                from: layer.tab
              }
            });            
          }
        }
      }

      // ------------------------------------------------------------
      // Handle layer show/hide

      function showLayer(layer) {
        console.log("showLayer:layer=", layer.name);
          loadLayer(layer);
          if (map) {
            layer.layer.setMap(map);
          }
      }

      function hideLayer(layer) {
        console.log("hideLayer:layer=", layer.name);
          if (map) {
            layer.layer.setMap(null);
          }
      }

      function showVisibleLayers() {
        for (var i = 0; i < layers.length; i++) {
          if (layers[i].visible) {
            showLayer(layers[i]);
          }
        }
      }

      function handleLayer(layer, show) {
        if (show == layer.visible) {
          // no change
          console.log("handleLayer:no change, layer=", layer.name);
          return;
        }
        layer.visible = show;
        if (show) {
          showLayer(layer);
        } else {
          hideLayer(layer);
        }
      }

      // ------------------------------------------------------------
      // Calculate circle radious based on map zoom

      function updateCircleRadius(zoom) {
        if (zoom >= 17) {
          circle_radius = 20 - zoom;
          if (circle_radius < 0.5) {
            circle_radius = 0.5;
          }
        } else {
          circle_radius = 5;
        }
        console.log('updateCircleRadius:zoom='+zoom+',circle_radius='+circle_radius);        
      }

      // ------------------------------------------------------------
      // Init map

      function initMap() {
        if (!start_maptypeid) {
          start_maptypeid = google.maps.MapTypeId.ROADMAP;
        }
        map = new google.maps.Map(document.getElementById('map'), {
          center: start_location,
          zoom : map_zoom,
          mapTypeId : start_maptypeid,
          mapTypeControlOptions: {
            mapTypeIds: [
                google.maps.MapTypeId.ROADMAP,
                google.maps.MapTypeId.SATELLITE,
                'peruskartta',
                'ortokuvat'
            ]
          }
        });

        // initMap: show markers listed in url

        for (var i = 0; i < url_markers.length; i++) {
          console.log('show markes, pos='+url_markers[i].pos+',label='+url_markers[i].label);
          var marker = new google.maps.Marker({
            position: url_markers[i].pos,
            map: map,
            title: 'Url marker',
            label: url_markers[i].label
          });
        }

        // ------------------------------------------------------------
        // initMap: DropDown menu when HTML5 dialog is not supported

        if (!supportHTML5Dialog) {

          var categoryDropDown = document.createElement("SELECT");

          var option = document.createElement("option");
          option.text = "No layer";
          categoryDropDown.add(option, 0);

          for (var i = 0; i < layers.length; i++) {
            option = document.createElement("option");
            option.text = layers[i].shortname;
            categoryDropDown.add(option, i + 1);
            if (layers[i].visible) {
              categoryDropDown.selectedIndex = i + 1;
            }
          }

          categoryDropDown.addEventListener("change", function() {
            var selIndex = categoryDropDown.selectedIndex;
            console.log("categoryDropDown.selectedIndex=", selIndex);
            // hide all non-selected layers
            for (var i = 0; i < layers.length; i++) {
              if (i != selIndex - 1) {
                handleLayer(layers[i], false);
              }           
            }
            // show selected layer
            if (selIndex > 0 && selIndex <= layers.length) {
              handleLayer(layers[selIndex - 1], true);
            }
          });

          categoryDropDown.style.marginBottom = '22px';

          map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(categoryDropDown);
        }

        // ------------------------------------------------------------
        // initMap: Dialog  menu to chose layers, with dialog menu multiple
        // layers can be visible at the same time

        if (supportHTML5Dialog) {
          var checkBox;

          layerDialog = document.createElement("DIALOG");

          document.body.appendChild(layerDialog);

          // Create check box for all layers
          for (var i = 0; i < layers.length; i++) {
            checkBox = document.createElement("INPUT");
            checkBox.setAttribute("type", "checkbox");
            checkBox.value = layers[i].name;
            checkBox.checked = layers[i].visible;
            checkBox.onclick = function() {
              console.log("layerDialog clicked, name=" + this.value + ",checked=", this.checked);
              for (var i = 0; i < layers.length; i++) {
                if (layers[i].name == this.value) {
                  handleLayer(layers[i], this.checked);
                }
              }
            };
            layerDialog.appendChild(checkBox);
            layerDialog.appendChild(document.createTextNode(layers[i].name));
            layerDialog.appendChild(document.createElement("BR"));            
          }

          // Close button
          var layerCloseButton = document.createElement("BUTTON");
          layerCloseButton.appendChild(document.createTextNode("Close"));
          layerCloseButton.onclick = function(){
            console.log("layerDialog Close clicked");
            layerDialog.close();
          };
          layerDialog.appendChild(layerCloseButton);
        }

        // ------------------------------------------------------------
        // initMap: Crosshair to show the map center

        var crosshairShape = {coords:[0,0,0,0],type:'rect'};
        centerMarker = new google.maps.Marker({
          map: map,
          icon: 'https://www.daftlogic.com/images/cross-hairs.gif',
          shape: crosshairShape
        });
        centerMarker.bindTo('position', map, 'center');
        centerMarker.setVisible(!autoMove);

        // ------------------------------------------------------------
        // initMap: Peruskartta 

        var perusMapType = new google.maps.ImageMapType({
          getTileUrl: function(coord, zoom) {
              return "http://tiles.kartat.kapsi.fi/peruskartta/" + zoom + "/" + 
                coord.x + "/" + coord.y + ".jpg";
          },
          tileSize: new google.maps.Size(256, 256),
          maxZoom: 19,
          minZoom: 0,
          name: 'Peruskartta'
        });

        map.mapTypes.set('peruskartta', perusMapType);
        //map.setMapTypeId('peruskartta'); // default is roadmap

        // ------------------------------------------------------------
        // initMap: Ortoilmakuvat

        var ortoMapType = new google.maps.ImageMapType({
          getTileUrl: function(coord, zoom) {
              return "http://tiles.kartat.kapsi.fi/ortokuva/" + zoom + "/" + 
                coord.x + "/" + coord.y + ".jpg";
          },
          tileSize: new google.maps.Size(256, 256),
          maxZoom: 19,
          minZoom: 0,
          name: 'Ortoilmakuvat'
        });

        map.mapTypes.set('ortokuvat', ortoMapType);

        // ------------------------------------------------------------
        // initMap: Init some variables

        marker = null;
        infoWindow = new google.maps.InfoWindow;

        function setDivStyle(div) {
          div.style.backgroundColor = '#fff';
          div.style.border = '2px solid #fff';
          div.style.borderRadius = '3px';
          div.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        }

        // ----------------------------------------------------------
        // initMap: GPS icon to center the map

        var gpsDiv = document.createElement('div');
        var gpsButton = document.createElement("IMG");
        gpsButton.src = 'https://ruuth.xyz/ic_gps_fixed_black_24px.svg';
        gpsButton.addEventListener('click', function() {
          map.panTo(current_location);
          autoMove = true;
          centerMarker.setVisible(!autoMove);
          console.log("click Center Map:autoMove=true");
        });
        setDivStyle(gpsDiv);
        gpsDiv.style.marginRight = '11px';
        gpsDiv.appendChild(gpsButton);
        map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(gpsDiv);

        // ----------------------------------------------------------
        // initMap: Buttons for extarnal maps: 
        //    1956 - Kirkkonummi aerial images from 1956
        //    MML Laser - Maanmittauslaitos laser scan for surface structures

        var externalMapsDiv = document.createElement('div');
        var button1956 = document.createElement("BUTTON");
        var button1956Text = document.createTextNode("1956");
        button1956.appendChild(button1956Text);
        button1956.addEventListener('click', function() {
          // save current state in case we return back
          saveState();          
          // ETRS-GK25 (EPSG:3879)
          var p = "+proj=tmerc +lat_0=0 +lon_0=25 +k=1 +x_0=25500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
          proj4.defs("ETRS-GK25", p);
          var map_center = map.getCenter();
          // convert map coordinates to ETRS-GK25 (EPSG:3879) that is used for aerial photos
          var coord = proj4('ETRS-GK25', [map_center.lng(), map_center.lat()]);
          var link = "https://kirkkonummi.karttatiimi.fi/?setlanguage=fi&e="+coord[0]+"&n="+coord[1]+"&r=1&w=&l=1956ortoilmakuva&o=100"+
                     "&geom=POINT("+coord[0]+"%20"+coord[1]+")";
          console.log("click 1956: jump to page " + link);
          //alert('jump to 1956');
          window.location.href = link;
        });
        externalMapsDiv.appendChild(button1956);

        var buttonLaser = document.createElement("BUTTON");
        var buttonLaserText = document.createTextNode("MML Laser");
        buttonLaser.appendChild(buttonLaserText);
        buttonLaser.addEventListener('click', function() {
          // save current state in case we return back
          saveState();          
          // ETRS-TM35FIN (EPSG:3067)
          var p = "+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
          proj4.defs("ETRS-TM35FIN", p);
          var map_center = map.getCenter();
          // convert map coordinates to ETRS-TM35FIN (EPSG:3067) that is used for maanmittauslaitos maps
          var coord = proj4('ETRS-TM35FIN', [map_center.lng(), map_center.lat()]);
          var link = "https://asiointi.maanmittauslaitos.fi/karttapaikka/?share=customMarker&"+
                     "n="+coord[1]+"&e="+coord[0]+
                     "&desc=&zoom=10&layers=%5B%7B%22id%22%3A186%2C%22opacity%22%3A50%7D%5D";
          console.log("click Laser: jump to page " + link);
          //alert('jump to MML');
          window.location.href = link;
        }); 
        externalMapsDiv.appendChild(buttonLaser);
        externalMapsDiv.style.marginBottom = '22px';

        map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(externalMapsDiv);

        // ----------------------------------------------------------
        // initMap: HTML5 dialog for layers

        if (supportHTML5Dialog) {
          var layersDiv = document.createElement('div');
          var layersButton = document.createElement("IMG");
          layersButton.src = 'https://ruuth.xyz/ic_layers_black_24px.svg';
          layersButton.addEventListener('click', function() {
            console.log("click Layer, layerDialog.showModal()");
            layerDialog.showModal();
          });
          setDivStyle(layersDiv);
          layersDiv.style.marginLeft = '11px';
          layersDiv.appendChild(layersButton);
          map.controls[google.maps.ControlPosition.LEFT_CENTER].push(layersDiv);
        }

        // ------------------------------------------------------------
        // initMap: Geolocation error

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
          var msg = browserHasGeolocation ?
                                'Error: The Geolocation service failed.' :
                                'Error: Your browser doesn\'t support geolocation.';
          console.log(msg);
          infoWindow.setPosition(pos);
          infoWindow.setContent(msg);
          infoWindow.open(map);
        }

        // ------------------------------------------------------------
        // initMap: Event listener for map type change (toggle stree view)

        map.addListener('maptypeid_changed', function() {
          var showStreetViewControl = map.getMapTypeId() != 'peruskartta'
                                      && map.getMapTypeId() != 'ortokuvat';
          map.setOptions({
            streetViewControl: showStreetViewControl
          });
        });

        // ------------------------------------------------------------
        // initMap: Event listener for user moving the map manually

        map.addListener('dragstart', function() {
            if (autoMove) {
              console.log('dragstart: set autoMove=false');
            }
            autoMove = false;
            centerMarker.setVisible(!autoMove);
        });

        // ------------------------------------------------------------
        // initMap: Event listener for user zooming the map
        
        google.maps.event.addListener(map, 'zoom_changed', function () {
          var old_radius = circle_radius;
          updateCircleRadius(map.getZoom());
          if (old_radius != circle_radius) {
            console.log("zoom_changed, change circle radius");
            for (var i = 0; i < path.length; i++) {
              path[i].setRadius(circle_radius);
            }
          }
        });

        // ------------------------------------------------------------
        // Options for getting position

        options = {
          enableHighAccuracy: true,
          timeout: Infinity,
          maximumAge: 10000
        };

        // ------------------------------------------------------------
        // Try HTML5 geolocation.

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                updatePosition, 
                function() {
                    handleLocationError(true, infoWindow, map.getCenter());
            });
            id = navigator.geolocation.watchPosition(updatePosition, watchError, options);
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      } // initMap: end

      // ------------------------------------------------------------
      // Update current position in the map

      function updatePosition(position) {  
            var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            current_location = pos;
            if (marker) {
                // move marker
                marker.setPosition(current_location);
            } else {
                // create marker
                marker = new google.maps.Marker({
                    position: current_location,
                    map: map                 
                });
                // click the marker to get coordinates
                marker.addListener('click', function() {
                    infoWindow.setPosition(current_location);
                    infoWindow.setContent('Lat: ' + current_location.lat + ' Lng: ' + current_location.lng);
                    infoWindow.open(map);
                  });
            }
            if (autoMove) {
              map.panTo(current_location);
            }
      }

      // ------------------------------------------------------------
      // Error function for position change watch

      function watchError(err) {
        infoWindow.setPosition(pos);
        infoWindow.setContent('Watch Error(' + err.code + '): ' + err.message);
        console.log('Watch Error(' + err.code + '): ' + err.message);
        infoWindow.open(map);
      }

      // ------------------------------------------------------------
      // add event listeners for page show/hide so we can continue 
      // from same state

      window.addEventListener('pageshow', function(event) {
        console.log("pageshow");
        restoreState(false);
        showVisibleLayers();
      });

      window.addEventListener('pagehide', function(event) {
        console.log("pagehide");
        saveState();
      });

      // ------------------------------------------------------------
      // Function to create a circle for the path

      function pathCircle(loc) {
        var new_circle = new google.maps.Circle({
                                  strokeColor: '#FF0000',
                                  strokeOpacity: 0.8,
                                  strokeWeight: 2,
                                  fillColor: '#FF0000',
                                  fillOpacity: 0.35,
                                  map: map,
                                  center: loc,
                                  radius: circle_radius,
                                  clickable : false
                                });
          return(new_circle);
      }

      // ------------------------------------------------------------
      // function to be called periodically to show path

      if (maxpath > 0) {
        setInterval(function() {
          if (path.length > 0 && map) {
            // check that we have moved enough to add a new marker
            var distance = google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(current_location),
                        path[0].getCenter());
            if (distance < recording_distance) {
              // we record new point only if we have moved enough
              console.log('Do not add new element, too short distance='+distance+',path.length='+path.length);
              return;
            }
          }        
          while (path.length > maxpath) {
            // hide old element
            path[path.length - 1].setMap(null);
            // remove from path
            path.pop();
          }

          // Add new circle to the map.
          var new_circle = pathCircle(current_location);
          // add as the first element in path
          path.unshift(new_circle);
        }, pathinterval);
      }

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1wlBXvTtUzuhgNudFux14Gn_okpmWztY&callback=initMap">
    </script>
  </body>
</html>